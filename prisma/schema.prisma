generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

// ============================================
// USER (Freelancer)
// ============================================
model User {
  id              String   @id @default(cuid())
  supabaseId      String   @unique @map("supabase_id")
  email           String   @unique
  firstName       String?  @map("first_name")
  lastName        String?  @map("last_name")
  businessName    String?  @map("business_name")
  phone           String?
  avatarUrl       String?  @map("avatar_url")
  
  // Business Details
  businessType    String?  @map("business_type")
  businessWebsite String?  @map("business_website")
  businessLogo    String?  @map("business_logo")
  taxId           String?  @map("tax_id")
  taxIdType       String?  @map("tax_id_type")
  
  // Business Address
  address         String?
  addressLine2    String?  @map("address_line_2")
  city            String?
  state           String?
  zipCode         String?  @map("zip_code")
  country         String   @default("US")
  
  // Settings
  timezone        String   @default("America/New_York")
  currency        String   @default("USD")
  defaultPaymentTerms Int  @default(14) @map("default_payment_terms")
  
  // Settings JSON
  invoiceSettings      Json?    @default("{}") @map("invoice_settings")
  notificationSettings Json?    @default("{}") @map("notification_settings")
  
  // Subscription
  subscriptionStatus  String   @default("trialing") @map("subscription_status")
  trialEndsAt         DateTime? @map("trial_ends_at")
  
  // Stripe Connect
  stripeAccountId           String?  @map("stripe_account_id")
  stripeAccountStatus       String?  @default("pending") @map("stripe_account_status")
  stripeOnboardingComplete  Boolean  @default(false) @map("stripe_onboarding_complete")
  stripeDetailsSubmitted    Boolean  @default(false) @map("stripe_details_submitted")
  stripeChargesEnabled      Boolean  @default(false) @map("stripe_charges_enabled")
  stripePayoutsEnabled      Boolean  @default(false) @map("stripe_payouts_enabled")
  
  // Reminder Settings
  reminderSettings Json?    @default("{}") @map("reminder_settings")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  clients         Client[]
  projects        Project[]
  invoices        Invoice[]
  contracts       Contract[]
  contractTemplates ContractTemplate[]
  portalMessages  PortalMessage[]
  timeEntries     TimeEntry[]
  
  @@index([supabaseId])
  @@index([email])
  @@map("users")
}

// ============================================
// CLIENT
// ============================================
model Client {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  name            String
  email           String
  phone           String?
  company         String?
  address         String?
  city            String?
  state           String?
  zipCode         String?  @map("zip_code")
  country         String   @default("US")
  
  // Portal Access
  portalEnabled       Boolean   @default(false) @map("portal_enabled")
  portalToken         String?   @unique @map("portal_token")
  portalTokenExp      DateTime? @map("portal_token_exp")
  lastPortalAccess    DateTime? @map("last_portal_access")
  
  notes           String?
  defaultHourlyRate Int?    @map("default_hourly_rate") // Rate in cents
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects        Project[]
  invoices        Invoice[]
  contracts       Contract[]
  portalSessions  PortalSession[]
  portalMessages  PortalMessage[]
  timeEntries     TimeEntry[]
  
  @@unique([userId, email])
  @@index([userId])
  @@map("clients")
}

// ============================================
// PROJECT
// ============================================
model Project {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  clientId        String   @map("client_id")
  code            String   @unique
  name            String
  description     String?
  status          String   @default("draft")
  projectType     String   @default("fixed") @map("project_type")
  totalAmount     Int      @default(0) @map("total_amount")
  paidAmount      Int      @default(0) @map("paid_amount")
  currency        String   @default("USD")
  startDate       DateTime? @map("start_date")
  endDate         DateTime? @map("end_date")
  revisionsCap    Int      @default(3) @map("revisions_cap")
  revisionsUsed   Int      @default(0) @map("revisions_used")
  extraRevisionFee Int     @default(5000) @map("extra_revision_fee")
  hourlyRate      Int?     @map("hourly_rate")  // Rate in cents
  estimatedHours  Int?     @map("estimated_hours")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  client          Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  milestones      Milestone[]
  invoices        Invoice[]
  contracts       Contract[]
  revisions       Revision[]
  timeEntries     TimeEntry[]
  
  @@index([userId])
  @@index([clientId])
  @@index([status])
  @@map("projects")
}

// ============================================
// MILESTONE
// ============================================
model Milestone {
  id              String   @id @default(cuid())
  projectId       String   @map("project_id")
  name            String
  description     String?
  orderIndex      Int      @default(0) @map("order_index")
  status          String   @default("pending")
  amount          Int      @default(0)
  dueDate         DateTime? @map("due_date")
  approvedAt      DateTime? @map("approved_at")
  approvedBy      String?   @map("approved_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  project         Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  deliverables    Deliverable[]
  invoiceItems    InvoiceItem[]
  timeEntries     TimeEntry[]
  
  @@index([projectId])
  @@map("milestones")
}

// ============================================
// DELIVERABLE
// ============================================
model Deliverable {
  id              String   @id @default(cuid())
  milestoneId     String   @map("milestone_id")
  name            String
  description     String?
  fileUrl         String?  @map("file_url")
  fileType        String?  @map("file_type")
  fileSize        Int?     @map("file_size")
  status          String   @default("pending")
  feedback        String?
  feedbackAt      DateTime? @map("feedback_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  milestone       Milestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  
  @@index([milestoneId])
  @@map("deliverables")
}

// ============================================
// REVISION
// ============================================
model Revision {
  id              String   @id @default(cuid())
  projectId       String   @map("project_id")
  revisionNumber  Int      @map("revision_number")
  description     String
  requestedBy     String   @map("requested_by")
  status          String   @default("pending")
  isExtra         Boolean  @default(false) @map("is_extra")
  amount          Int      @default(0)
  invoiceId       String?  @map("invoice_id")
  completedAt     DateTime? @map("completed_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  invoice         Invoice? @relation(fields: [invoiceId], references: [id])
  
  @@index([projectId])
  @@map("revisions")
}

// ============================================
// CONTRACT
// ============================================
model Contract {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  clientId        String   @map("client_id")
  projectId       String?  @map("project_id")
  code            String   @unique
  name            String
  content         String
  status          String   @default("draft")
  freelancerSignedAt  DateTime? @map("freelancer_signed_at")
  freelancerSignature String?   @map("freelancer_signature")
  clientSignedAt      DateTime? @map("client_signed_at")
  clientSignature     String?   @map("client_signature")
  clientIp            String?   @map("client_ip")
  sentAt          DateTime? @map("sent_at")
  viewedAt        DateTime? @map("viewed_at")
  expiresAt       DateTime? @map("expires_at")
  pdfUrl          String?  @map("pdf_url")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project         Project? @relation(fields: [projectId], references: [id])
  
  @@index([userId])
  @@index([clientId])
  @@index([status])
  @@map("contracts")
}

// ============================================
// CONTRACT TEMPLATE
// ============================================
model ContractTemplate {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  name            String
  description     String?
  content         String
  isDefault       Boolean  @default(false) @map("is_default")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("contract_templates")
}

// ============================================
// INVOICE
// ============================================
model Invoice {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  clientId        String   @map("client_id")
  projectId       String?  @map("project_id")
  invoiceNumber   String   @unique @map("invoice_number")
  status          String   @default("draft")
  subtotal        Int      @default(0)
  taxRate         Float    @default(0) @map("tax_rate")
  taxAmount       Int      @default(0) @map("tax_amount")
  discountAmount  Int      @default(0) @map("discount_amount")
  total           Int      @default(0)
  amountPaid      Int      @default(0) @map("amount_paid")
  currency        String   @default("USD")
  issueDate       DateTime @default(now()) @map("issue_date")
  dueDate         DateTime @map("due_date")
  paidAt          DateTime? @map("paid_at")
  stripePaymentIntent String?  @map("stripe_payment_intent")
  paymentLink         String?  @map("payment_link")
  stripePaymentLinkId   String?  @map("stripe_payment_link_id")
  stripePaymentLinkUrl  String?  @map("stripe_payment_link_url")
  stripeCheckoutSessionId String?  @map("stripe_checkout_session_id")
  notes           String?
  terms           String?
  pdfUrl          String?  @map("pdf_url")
  sentAt          DateTime? @map("sent_at")
  viewedAt        DateTime? @map("viewed_at")
  reminderCount   Int       @default(0) @map("reminder_count")
  lastReminderAt  DateTime? @map("last_reminder_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  client          Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project         Project?      @relation(fields: [projectId], references: [id])
  items           InvoiceItem[]
  payments        Payment[]
  revisions       Revision[]
  reminders       ReminderSchedule[]
  timeEntries     TimeEntry[]
  
  @@index([userId])
  @@index([clientId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

// ============================================
// INVOICE ITEM
// ============================================
model InvoiceItem {
  id              String   @id @default(cuid())
  invoiceId       String   @map("invoice_id")
  milestoneId     String?  @map("milestone_id")
  description     String
  quantity        Float    @default(1)
  unitPrice       Int      @map("unit_price")
  amount          Int
  createdAt       DateTime @default(now()) @map("created_at")
  
  invoice         Invoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  milestone       Milestone? @relation(fields: [milestoneId], references: [id])
  
  @@index([invoiceId])
  @@map("invoice_items")
}

// ============================================
// PAYMENT
// ============================================
model Payment {
  id              String   @id @default(cuid())
  invoiceId       String   @map("invoice_id")
  amount          Int
  currency        String   @default("USD")
  stripePaymentId String?  @map("stripe_payment_id")
  stripePaymentIntentId String?  @map("stripe_payment_intent_id")
  stripeSessionId       String?  @map("stripe_session_id")
  stripeChargeId        String?  @map("stripe_charge_id")
  paymentMethod   String?  @map("payment_method")
  method          String?
  status          String   @default("succeeded")
  notes           String?
  paidAt          DateTime @default(now()) @map("paid_at")
  createdAt       DateTime @default(now()) @map("created_at")
  
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@index([invoiceId])
  @@index([stripePaymentIntentId])
  @@map("payments")
}

// ============================================
// REMINDER SCHEDULE
// ============================================
model ReminderSchedule {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  invoiceId       String   @map("invoice_id")
  reminderType    String   @map("reminder_type")
  daysOffset      Int      @map("days_offset")
  status          String   @default("scheduled")
  scheduledFor    DateTime @map("scheduled_for")
  sentAt          DateTime? @map("sent_at")
  isEscalation    Boolean  @default(false) @map("is_escalation")
  escalationLevel Int      @default(0) @map("escalation_level")
  error           String?
  emailId         String?   @map("email_id")
  createdAt       DateTime @default(now()) @map("created_at")
  
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@index([invoiceId])
  @@index([scheduledFor])
  @@index([status])
  @@map("reminder_schedules")
}

// ============================================
// PORTAL SESSION
// ============================================
model PortalSession {
  id          String   @id @default(uuid())
  clientId    String   @map("client_id")
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  token       String   @unique
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")
  lastUsedAt  DateTime @default(now()) @map("last_used_at")
  userAgent   String?  @map("user_agent")
  ipAddress   String?  @map("ip_address")
  
  @@index([clientId])
  @@index([token])
  @@map("portal_sessions")
}

// ============================================
// PORTAL MESSAGE
// ============================================
model PortalMessage {
  id          String   @id @default(uuid())
  clientId    String   @map("client_id")
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content     String
  senderType  String   @map("sender_type") // 'client' or 'freelancer'
  readAt      DateTime? @map("read_at")
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@index([clientId])
  @@index([userId])
  @@map("portal_messages")
}

// ============================================
// TIME ENTRY
// ============================================
model TimeEntry {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Optional associations
  clientId        String?   @map("client_id")
  client          Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  projectId       String?   @map("project_id")
  project         Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  milestoneId     String?   @map("milestone_id")
  milestone       Milestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  
  // Time data
  description     String
  date            DateTime  @db.Date
  startTime       DateTime? @map("start_time")
  endTime         DateTime? @map("end_time")
  duration        Int       // Duration in minutes
  
  // Billing
  billable        Boolean   @default(true)
  billed          Boolean   @default(false)
  hourlyRate      Int?      @map("hourly_rate") // Rate in cents
  
  // Invoice reference
  invoiceId       String?   @map("invoice_id")
  invoice         Invoice?  @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  invoiceItemId   String?   @map("invoice_item_id")
  
  // Timer state
  isRunning       Boolean   @default(false) @map("is_running")
  timerStartedAt  DateTime? @map("timer_started_at")
  
  // Metadata
  tags            String[]  @default([])
  notes           String?
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@index([userId])
  @@index([clientId])
  @@index([projectId])
  @@index([date])
  @@index([isRunning])
  @@map("time_entries")
}
